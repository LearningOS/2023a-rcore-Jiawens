# Lab 1报告

## 我实现的功能

在`TaskControlBlockTaskControlBlock`中增加了任务第一次被调度的时间和系统调用次数两个变量，在陷入trap，前去执行对应系统调用之前将相应计数加一，在第一次调度某个任务时设置它的“第一次被调度时间”，增加了一个名为`sys_task_info`的系统调用，该系统调用会返回该任务的运行状态（始终为Running）、该任务调用syscall的次数、该任务以毫秒计的执行时间（包括被阻塞的时间）。

## 简答题

### 1

> 以下使用的均为classroom自带的rusbsbi-qemu，版本为 0.3.0-alpha.2 。

#### ch2b_bad_address.rs

内核报错信息：

```
[kernel] PageFault in application, bad addr = 0x0, bad instruction = 0x804003c4, kernel killed it.
```

此程序试图向地址0x0中写入0，而0x0是非法的内存地址，因此内核捕捉到了此错误，并且终止了程序，输出该程序发生了PageFault，并输出了错误的地址和出现错误的指令的地址。

#### ch2b_bad_instructions.rs

内核报错信息：

```
[kernel] IllegalInstruction in application, kernel killed it.
```

此程序处在U模式，却试图执行sret指令（一条S模式专属的指令，勇于从trap中返回），因此内核捕捉到了这个非法行为，终止程序后输出了该程序执行IllegalInstruction的信息。

#### ch2b_bad_register.rs

内核报错信息：

```
[kernel] IllegalInstruction in application, kernel killed it.
```

此程序处于U模式，试图执行csrr（读取一个csr的值到通用寄存器）指令，读取sstatus，但sstatus仅有S模式才能访问，因此内核捕捉到了这个非法行为，终止程序后输出了该程序执行IllegalInstruction的信息。

### 2

1. L40: 刚进入`__restore`时，a0代表内核栈的栈顶；`__restore`具有以下两种使用情景：内核执行初始化完成后，准备启动第一个应用程序时可构造一个trap上下文，然后使用__restore跳转到该上下文所包含的程序入口；当一个应用程序触发trap时，内核处理完该trap后会使用__restore跳转到该程序的下一条指令处开始执行，或是跳转到另一个程序开始执行（当这个trap是因为异常(PageFault等)而触发时）

2. L43-L48: 这几行汇编代码处理了sstatus、sepc、sscratch三个寄存器。sstatus寄存器保存了trap之前处于的特权等级，有助于在trap返回后恢复正确的特权等级（比如U模式的应用程序调用syscall后不可以成为S模式再运行程序）；sepc寄存器保存了trap处理完成之后应当跳转到的指令地址，从而能够继续执行程序；sscratch寄存器保存了用户栈的栈顶，下文又将sp和sscratch交换，使得trap处理完成后sp指向用户栈的栈顶，程序能够正常使用用户栈，内核也能在下次trap时记住内核栈的栈顶。

3. L50-L56: x2即sp，此时指向内核栈栈顶，下文中我们还需要用sp恢复寄存器状态，且最后会将x2设置为用户栈栈顶，因此此时跳过；x4即tp，线程指针，一般不会用到，因此此时不保存。

4. L60: 该指令交换了sp和sscratch的值，执行完成后sp指向用户栈栈顶，sscratch指向内核栈栈顶。

5. `__restore`: 状态切换发生在L61 `sret` 指令处，该指令的其中一个效果是在跳转后将特权等级设置为sstatus中的值，而此时sstatus的值为U，故执行此条指令后会进入用户态。

6. L13: 该指令之后，sp指向内核栈栈顶，sscratch指向用户栈栈顶。

7. 以user/src/syscall.rs中的syscall函数为例，该函数包括一条`ecall`指令，而从U态进入S态就是`ecall`指令发生的。

## 荣誉准则

在完成本次实验的过程（含此前学习的过程）中，我曾分别与 以下各位 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：

> 无

此外，我也参考了 以下资料 ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：

> rCore-Tutorial-Guide-2023A 文档，编写此实验报告时参考了其中的部分内容
>
> 我的学习日记中提到的参考链接（截止撰写此荣誉准则时，其中所有参考均是为了搭建环境）

3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。